<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<script src="http://d3js.org/d3.v3.min.js"></script>
		<script src="http://d3js.org/queue.v1.min.js"></script>
		<style>
		
			h2{
				text-align: center;
				color : black;
			}
			
		
		</style>
		<script type = "text/javascript">
		//var states_info ={}
		
		
		function draw(geo_data){
			
			var margin = 50,
				width = 1400-margin,
				height = 600- margin;
				
		
	
			var svg = d3.select('body')
						.append('svg')
						.attr('width', width + margin)
						.attr('height', height + margin)
						.append('g')
						.attr('class', 'map');
	
			
			//console.log(svg);
			
			//https://github.com/d3/d3-3.x-api-reference/blob/master/Geo-Projections.md
			// project cordinates into pixels
			var projection = d3.geo.albersUsa()								
								.translate([width/2, height/2]);
								
			// path(): construct the SVG object to correctly render pixels
			// projection(): then do projection
			var map_path = d3.geo.path().projection(projection)
			
			
			var map = svg.selectAll("path")
						.data(geo_data.features)
						.enter()
						.append("path")
						.attr('d', map_path)
						.style('fill', 'lightBlue')
						.style('stroke', 'black')
						.style('stroke-width', .5);
			
			///// getting latitude, longitude information of each state
			
			
				
			function plot_points(error, lat_lon, loan){

			//console.log(state_lat_lon);
				
			/***************** states_geo_data ****************/
				var states_info = {}
				lat_lon.forEach(function(d){
										var lat = +d.latitude,
											lon = +d.longitude,
											coords = projection([lon, lat]);
										//debugger;
										var x = coords[0],
											y = coords[1];
										
										states_info[d.state] = {'lon' : lon
																, 'lat' :lat
																, 'name': d.state_name
																, 'center_x': x
																, 'center_y': y}
										}
									);
				
				
			/***************** loan data ****************/
				var format = d3.time.format('%Y-%m-%d %H:%M:%S');
				
				function grouping_status(status){
						if (status.startsWith('Past')){
						  return 'Past_Due';
						}
						else if(status.startsWith('Completed')){
						  return 'Completed';
						}
						
						else if(status.startsWith('Default') | status.startsWith('Charged')){
						  return 'ChargedOff_Default';
						}
						else if(status.startsWith('Current')){
						  return 'Current';
						  }		
						else {
						  return 'Others';
						}
					  }
					
				//d3.csv('prosperLoanData.csv'
				var loan_data = loan.map(function(d){
											function state_blank(state){
												if (state){return state;}
												else {return "na";}
												;
											}
										//debugger;
										var new_d = {}
										new_d['LoanOriginationDate']=format.parse(d['LoanOriginationDate']);
										new_d['LoanOriginationYear']=new_d['LoanOriginationDate'].getUTCFullYear(); 
										new_d['LoanOriginalAmount'] = +d['LoanOriginalAmount']; // +: convert datatype to numeric from string
										new_d['BorrowerAPR']= +d['BorrowerAPR']
										new_d['LoanStatus_grouped'] = grouping_status(d['LoanStatus'])
										new_d['BorrowerState'] = state_blank(d['BorrowerState'])									
										
										//debugger;
										return new_d;
										}
						);
				
				//console.log(loan_data)
					
					
				function agg_year(leaves){
			  
					  var loan_amount = d3.sum(leaves
											, function(d){return d.LoanOriginalAmount;});
					  //debugger;
					  var group = leaves.map(function(d) {return d.LoanStatus_grouped;});
					  
					  /// need to agg by group!
					  
					  var loan_count = leaves.length
					  
					  return {'loan_amount': loan_amount, 'loan_count':loan_count}			  
					}

				var nested = d3.nest()
								.key(function(d){return d.LoanOriginationYear;})
								.key(function(d){return d.BorrowerState;})
								.rollup(agg_year)
								.entries(loan_data);
				
				
				
				
	////filtered for test
				var year = 2006;
				filtered = nested.filter(function(d){
											return new Date(d['key']).getUTCFullYear() === year;
											});
	////filtered for test
				
				filtered= filtered.map(function(d){
									var by_state = d.values;
									by_state.map(function(state){
															var state_info = states_info[state.key];
															state.x = state_info.center_x;
															state.y = state_info.center_y;
															
															return state;
															}
													)
									
									
									return by_state;}
									)[0];
				
				console.log(filtered)
				//console.log(filtered.map(function(d){return d.values}))
				
				
				var amounts = [],
					counts = [];
					
				nested.forEach(function(by_year){
									var year = by_year.key,
										by_state = by_year.values;
									
									by_state.map(function(d){
													var state = d.key,
														amount = d.values.loan_amount,
														count = d.values.loan_count;
													amounts.push(amount);
													counts.push(count);													
													}
												)									
									}
								)
				debugger;			
				
				var amount_extent = d3.extent(amounts),
					count_extent = d3.extent(counts);
			
				var radius = d3.scale.sqrt()
							.domain(amount_extent)
							.range([0,30]);
				
				console.log(radius)
			
			/************ draw points ************/						
				
				//, key_func
				svg.append('g')
					.attr('class', 'bubble')
					.selectAll('circle')
					.data(filtered)
					.enter()
					.append('circle')
					.attr('cx', function(d,index){return d.x;})
					.attr('cy', function(d,index){return d.y;})
					.attr('r', function(d,index){return radius(d.values.loan_amount); })
					.attr('fill', 'rgb(247,148,32)')
					.attr('stroke', 'black')
					.attr('stroke-width', 0.7)
					.attr('opacity', 0.7);
					;
				
				debugger;
			}
			
			queue()
				.defer(d3.csv, 'data/state_lat_lon.csv')
				.defer(d3.csv, 'data/prosperLoanData.csv')
				.await(plot_points);
					
				//debugger;
						
		};			

		</script>
	
	
	</head>
		
	<body>
		<script type = "text/javascript">
			
			//var state_lat_lon = 

			d3.json("data/us_state.json", draw)
		
		</script>
		
	</body>
		
</html>